$(document).ready(function() {
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Add to cart functionality
    $(document).on('click', '.add-to-cart', function(e) {
        e.preventDefault();
        const productId = $(this).data('product-id');
        
        $.ajax({
            url: 'api/add_to_cart.php',
            method: 'POST',
            data: {
                product_id: productId,
                csrf_token: '<?= generateCsrfToken() ?>'
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    updateCartCount(response.cart_count);
                    showToast('Product added to cart!', 'success');
                } else {
                    showToast(response.message || 'Error adding to cart', 'danger');
                }
            },
            error: function() {
                showToast('Network error. Please try again.', 'danger');
            }
        });
    });
    
    // Quick view modal
    $(document).on('click', '.quick-view', function() {
        const productId = $(this).data('product-id');
        
        $.get('api/get_product_details.php', { id: productId }, function(data) {
            if (data.success) {
                $('#quickViewModal .modal-title').text(data.product.name);
                $('#quickViewModal .product-image').attr('src', data.product.image_url);
                $('#quickViewModal .product-price').text('KSh ' + data.product.price.toLocaleString());
                $('#quickViewModal .product-description').text(data.product.description);
                $('#quickViewModal .product-seller').text(data.product.seller_name);
                $('#quickViewModal .product-location').text(data.product.location);
                $('#quickViewModal .product-quantity').text(data.product.quantity_available);
                
                // Update add to cart button in modal
                $('#quickViewModal .add-to-cart').data('product-id', productId);
                
                // Show modal
                new bootstrap.Modal(document.getElementById('quickViewModal')).show();
            } else {
                showToast('Product details not available', 'danger');
            }
        }, 'json').fail(function() {
            showToast('Error loading product details', 'danger');
        });
    });
    
    // Update cart count in UI
    function updateCartCount(count) {
        $('.cart-count').text(count).removeClass('d-none');
    }
    
    // Show toast notifications
    function showToast(message, type) {
        const toast = $(`<div class="toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>`);
        
        $('body').append(toast);
        new bootstrap.Toast(toast[0]).show();
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // Load initial cart count
    $.get('api/get_cart_count.php', function(data) {
        if (data.success && data.count > 0) {
            updateCartCount(data.count);
        }
    }, 'json');
});